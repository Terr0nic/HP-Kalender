<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Theorie-Unterricht ‚Äì Kalender</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow:0 14px 40px rgba(2,6,23,.10);
      --radius:18px;
      --branchAccent:#2563eb;

      --holidayBg:#f1f5f9;
      --holidayBorder:#cbd5e1;

      --base:16px;
      --line:1.45;
      --h1:24px;
      --btn:15px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      font-size:var(--base);
      line-height:var(--line);
    }

    .wrap{max-width:1280px;margin:28px auto;padding:0 16px}
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:12px;
    }
    h1{
      margin:0;
      font-size:var(--h1);
      letter-spacing:-.2px;
      display:flex; gap:10px; align-items:center;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; left:0; top:0; right:0;
      height:6px; background:var(--branchAccent);
    }

    select,button{
      font-size:var(--btn);
      padding:11px 13px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      font-weight:900;
      color:#111827;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    select:hover,button:hover{
      box-shadow:0 10px 22px rgba(15,23,42,.08);
      border-color:rgba(37,99,235,.25);
    }
    button.primary{
      background:var(--branchAccent);
      border-color:transparent;
      color:#fff;
    }
    button.ghost{background:#fff}
    button.pill{
      border-radius:999px;
      padding:10px 14px;
    }
    .iconBtn{
      width:42px;height:42px;
      border-radius:999px;
      padding:0;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:18px;
      font-weight:950;
    }

    /* Branch buttons */
    .branchBar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
    .bbtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:950;color:#111827;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .bbtn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(16,24,40,.08);border-color:rgba(37,99,235,.25)}
    .bbtn .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .bbtn.active{border-color:rgba(15,23,42,.25);background:#111827;color:#fff}

    /* Premium top toolbar */
    .toolbar{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .toolbar{grid-template-columns:1fr}
    }

    .nextBar{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg,#ffffff 0%, #fbfcff 100%);
      padding:12px 14px;
      position:relative;
      overflow:hidden;
    }
    .nextBar::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:7px;
      background:var(--branchAccent);
      opacity:.85;
    }
    .nextTitle{font-weight:950; color:#334155; font-size:12px; display:flex; gap:8px; align-items:center}
    .nextLine{font-weight:950; font-size:15px; margin-top:6px}
    .nextSub{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}

    .controlsRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .controlsRow select{min-width:320px}
    @media (max-width:520px){ .controlsRow select{min-width:100%} }

    /* Tabs row */
    .bar2{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;
      padding:12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      margin-bottom:12px;
    }

    .seg{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .seg button{border-radius:999px}
    .seg button.active{background:#111827;color:#fff;border-color:#111827}

    /* Calendar */
    #calendarWrap{
      padding-top:8px;
      border-top:1px solid var(--border);
    }
    table.cal{width:100%;border-collapse:separate;border-spacing:8px}
    .cal th{font-size:12px;color:#475569;text-align:left;padding:0 6px}

    .day{
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      min-height:142px;
      background:linear-gradient(180deg,#fff 0%, #fbfcff 100%);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      position:relative;
    }
    .day:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(16,24,40,.10);border-color:rgba(37,99,235,.25)}
    .day.muted{opacity:.45}
    .day.past{opacity:.45; filter:saturate(.85)}
    .dateLine{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      color:#475569; font-size:12px;
    }
    .dateLine strong{color:#0f172a}
    .wk{font-weight:900; color:#334155}

    @keyframes pulseRing {
      0%   { box-shadow:0 0 0 0 rgba(37,99,235,.35); }
      70%  { box-shadow:0 0 0 8px rgba(37,99,235,0); }
      100% { box-shadow:0 0 0 0 rgba(37,99,235,0); }
    }
    .day.today{outline:2px solid rgba(37,99,235,.25);outline-offset:2px;animation:pulseRing 2.2s ease-out infinite}

    .badges{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .badge{
      border-radius:16px;
      padding:10px 10px;
      font-size:12px;
      border:1px solid rgba(0,0,0,.06);
      line-height:1.25;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .badge::before{
      content:""; position:absolute; left:0; top:0; bottom:0; width:6px;
      background:rgba(37,99,235,.45);
    }
    .badge .top{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;white-space:nowrap}

    .badge.hafen{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.24)}
    .badge.hafen::before{background:rgba(245,158,11,.62)}
    .badge.off{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.24)}
    .badge.off::before{background:rgba(239,68,68,.62)}
    .badge.holiday{background:var(--holidayBg);border-color:var(--holidayBorder);color:#475569;font-style:italic}
    .badge.holiday::before{background:#94a3b8}

    /* List */
    .list{
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .listHead{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin:10px 0 8px;
    }
    .list h3{margin:0;font-size:16px}
    .hint{color:var(--muted); font-size:12px; font-weight:750}
    .item{
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      background:#fff;
      cursor:pointer;
    }
    .item + .item{margin-top:10px}
    .when{font-weight:950}
    .small{color:var(--muted);font-size:12px;margin-top:2px;line-height:1.35}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; background:rgba(15,23,42,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:9999;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff; border:1px solid rgba(0,0,0,.08);
      border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .modalHeader .title{font-weight:950}
    .modalHeader .meta{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
    .modalClose{border:1px solid var(--border); border-radius:14px; background:#fff; padding:8px 10px; cursor:pointer; font-weight:950}
    .modalBody{padding:14px}
    .modalBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fafbff; font-weight:950; font-size:12px;
    }
    .modalBody p{margin:10px 0 0; line-height:1.45}
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <h1>üö¶ Theorie-Unterricht</h1>
  </div>

  <div class="card" id="mainCard">

    <!-- Branch buttons -->
    <div class="branchBar" id="branchBar"></div>

    <!-- Premium toolbar: next + controls -->
    <div class="toolbar">
      <div class="nextBar" id="nextBar">
        <div class="nextTitle">‚è≠Ô∏è N√§chster Unterricht</div>
        <div class="nextLine" id="nextLine">‚Äî</div>
        <div class="nextSub" id="nextSub">‚Äî</div>
      </div>

      <div class="controlsRow">
        <select id="branch"></select>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div style="display:flex; gap:8px; align-items:center; border:1px solid var(--border); border-radius:999px; padding:6px 8px; background:#fff;">
            <button class="iconBtn ghost" id="prevMonth" type="button" aria-label="Vorheriger Monat">‚Äπ</button>
            <div style="font-weight:950; min-width:170px; text-align:center" id="monthTitle">‚Äî</div>
            <button class="iconBtn ghost" id="nextMonth" type="button" aria-label="N√§chster Monat">‚Ä∫</button>
          </div>
          <button class="pill primary" id="goToday" type="button">Heute</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bar2">
      <div class="seg">
        <button id="viewBoth" class="active" type="button">Kalender + Liste</button>
        <button id="viewCal" type="button">Kalender</button>
        <button id="viewList" type="button">Liste</button>
      </div>
    </div>

    <!-- Calendar -->
    <div id="calendarWrap">
      <table class="cal">
        <thead>
          <tr><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th></tr>
        </thead>
        <tbody id="calBody"></tbody>
      </table>
    </div>

    <!-- List -->
    <div class="list" id="listWrap"></div>
  </div>
</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-label="Details">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <div class="title" id="mTitle">‚Äî</div>
        <div class="meta" id="mMeta">‚Äî</div>
      </div>
      <button class="modalClose" id="mClose" type="button">Schlie√üen</button>
    </div>
    <div class="modalBody">
      <span class="modalBadge" id="mBadge">‚Äî</span>
      <p id="mBody">‚Äî</p>
    </div>
  </div>
</div>

<script>
(() => {
  /* ======================
     NUR HIER PFLEGEN
  ====================== */
  const CONFIG = {
    anchors: {
      hemshof:    { date: "2026-01-20", lessonNo: 2 },
      innenstadt: { date: "2026-01-19", lessonNo: 1 },
      seckenheim: { date: "2026-01-20", lessonNo: 9 }
    },
    closures: {
      hemshof: [],
      innenstadt: [],
      seckenheim: [],
      hafen: []
    }
  };

  const TOPICS = [
    "Pers√∂nliche Voraussetzungen / Risikofaktor Mensch",
    "Rechtliche Rahmenbedingungen",
    "Grundregeln, Verkehrszeichen und Verkehrseinrichtungen",
    "Stra√üenverkehrssystem und seine Nutzung, Bahn√ºberg√§nge",
    "Vorfahrt / Vorrang",
    "Verkehrsregelungen",
    "Geschwindigkeit, Abstand und umweltschonende Fahrweise",
    "Andere Teilnehmer im Stra√üenverkehr",
    "Verkehrsverhalten bei Fahrman√∂vern, Verkehrsbeobachtung",
    "Ruhender Verkehr, Absichern, Abschleppen",
    "Besondere Situationen, Verst√∂√üe gegen Vorschriften",
    "Lebenslanges Lernen",
    "Technische Bedingungen, Personen- und G√ºterbef√∂rderung",
    "Fahren mit Solokraftfahrzeugen und Z√ºgen, umweltschonender Umgang"
  ];
  const TOPIC_EMOJIS = ["üß†","‚öñÔ∏è","üö¶","üõ§Ô∏è","‚û°Ô∏è","üìã","‚è±Ô∏è","üö∂‚Äç‚ôÇÔ∏è","üëÄ","üÖøÔ∏è","‚ö†Ô∏è","üìö","üîß","üå±"];

  const BRANCHES = [
    { id:"innenstadt", name:"Mannheim Innenstadt", type:"PKW", state:"BW", isoDays:[1,3], timeText:"18:00‚Äì19:30", dayLabel:"Mo + Mi", accent:"#2563eb" },
    { id:"seckenheim", name:"Mannheim Seckenheim", type:"PKW", state:"BW", isoDays:[2,4], timeText:"18:00‚Äì19:30", dayLabel:"Di + Do", accent:"#16a34a" },
    { id:"hemshof", name:"Ludwigshafen Hemshof", type:"PKW", state:"RLP", isoDays:[2,4], timeText:"18:00‚Äì19:30", dayLabel:"Di + Do", accent:"#0891b2" },
    { id:"hafen", name:"Mannheim Hafen (LKW/BUS)", type:"HAFEN", state:"BW", isoDays:[3], timeText:"17:00‚Äì20:00", dayLabel:"Mi", accent:"#f59e0b" }
  ];

  const $ = (id) => document.getElementById(id);
  const elBranch = $("branch");
  const elBranchBar = $("branchBar");
  const elMonthTitle = $("monthTitle");
  const elCalBody = $("calBody");
  const elListWrap = $("listWrap");
  const elNextLine = $("nextLine");
  const elNextSub = $("nextSub");

  const modalOverlay = $("modalOverlay");
  const mTitle = $("mTitle");
  const mMeta = $("mMeta");
  const mBadge = $("mBadge");
  const mBody = $("mBody");

  const pad2 = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const startOfDay = (d)=>new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d,n)=>new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
  const jsToIso = (jsDay)=>(jsDay===0?7:jsDay);

  const fmtDE = (d)=>new Intl.DateTimeFormat("de-DE",{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"}).format(d);
  const fmtWk = (d)=>new Intl.DateTimeFormat("de-DE",{weekday:"short"}).format(d);
  const fmtDayMonth = (d)=>new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit"}).format(d);

  const escapeHtml = (s)=>String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function getBranch(){ return BRANCHES.find(b=>b.id===elBranch.value) || BRANCHES[0]; }
  function applyBranchAccent(){
    const b = getBranch();
    document.documentElement.style.setProperty("--branchAccent", b.accent || "#2563eb");
  }
  function topicStyle(lessonNo){
    const hue = Math.round((lessonNo - 1) * (360 / 14));
    return { bg: `hsla(${hue}, 85%, 94%, 1)`, border: `hsla(${hue}, 65%, 72%, 1)` };
  }

  function parseClosureSet(arr) {
    const set = new Set();
    const lines = Array.isArray(arr) ? arr : [];
    for (const l0 of lines) {
      const l = String(l0).trim();
      if (!l) continue;
      if (l.includes("..")) {
        const [a,b] = l.split("..").map(x=>x.trim());
        if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) continue;
        let d1 = startOfDay(new Date(a+"T00:00:00"));
        let d2 = startOfDay(new Date(b+"T00:00:00"));
        if (d1 > d2) [d1,d2] = [d2,d1];
        while (d1 <= d2) { set.add(toISODate(d1)); d1 = addDays(d1,1); }
      } else {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(l)) continue;
        set.add(l);
      }
    }
    return set;
  }

  function easterSunday(year) {
    const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4;
    const f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3);
    const h = (19*a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4;
    const l = (32 + 2*e + 2*i - h - k) % 7, m = Math.floor((a + 11*h + 22*l) / 451);
    const month = Math.floor((h + l - 7*m + 114) / 31);
    const day = ((h + l - 7*m + 114) % 31) + 1;
    return new Date(year, month - 1, day);
  }
  function addHoliday(map, date, name){
    const k = toISODate(date);
    if (!map.has(k)) map.set(k, name);
  }
  function buildHolidayMap(year, state) {
    const map = new Map();
    addHoliday(map, new Date(year,0,1), "Neujahr");
    addHoliday(map, new Date(year,4,1), "Tag der Arbeit");
    addHoliday(map, new Date(year,9,3), "Tag der Deutschen Einheit");
    addHoliday(map, new Date(year,11,25), "1. Weihnachtstag");
    addHoliday(map, new Date(year,11,26), "2. Weihnachtstag");

    const easter = easterSunday(year);
    addHoliday(map, addDays(easter,-2), "Karfreitag");
    addHoliday(map, addDays(easter,1), "Ostermontag");
    addHoliday(map, addDays(easter,39), "Christi Himmelfahrt");
    addHoliday(map, addDays(easter,50), "Pfingstmontag");

    if (state === "BW") {
      addHoliday(map, new Date(year,0,6), "Heilige Drei K√∂nige");
      addHoliday(map, new Date(year,10,1), "Allerheiligen");
      addHoliday(map, addDays(easter,60), "Fronleichnam");
    }
    if (state === "RLP") {
      addHoliday(map, new Date(year,10,1), "Allerheiligen");
      addHoliday(map, addDays(easter,60), "Fronleichnam");
    }
    return map;
  }

  function nextMatchingLessonDay(fromDate, isoDays) {
    let d = startOfDay(fromDate);
    for (let i=0;i<20;i++){
      if (isoDays.includes(jsToIso(d.getDay()))) return d;
      d = addDays(d,1);
    }
    return startOfDay(fromDate);
  }

  function buildScheduleForward(branch, yearNow, closureSet) {
    const windowStart = new Date(`${yearNow}-01-01T00:00:00`);
    const windowEnd   = new Date(`${yearNow+1}-12-31T00:00:00`);

    const holA = buildHolidayMap(yearNow, branch.state);
    const holB = buildHolidayMap(yearNow+1, branch.state);
    const holidayMap = new Map([...holA.entries(), ...holB.entries()]);

    const notes = new Map();
    for (const [dISO, name] of holidayMap.entries()) {
      if (!notes.has(dISO)) notes.set(dISO, []);
      notes.get(dISO).push({kind:"HOLIDAY", text:name});
    }

    let anchorDate = windowStart;
    let anchorLessonNo = 1;

    if (branch.type === "PKW" && CONFIG.anchors && CONFIG.anchors[branch.id]) {
      const a = CONFIG.anchors[branch.id];
      if (a && /^\d{4}-\d{2}-\d{2}$/.test(a.date) && Number.isFinite(a.lessonNo)) {
        anchorDate = new Date(a.date + "T00:00:00");
        anchorLessonNo = Math.min(14, Math.max(1, parseInt(a.lessonNo,10)));
      }
    }
    if (branch.type === "PKW") anchorDate = nextMatchingLessonDay(anchorDate, branch.isoDays);

    let topicIndex = anchorLessonNo - 1;
    const events = [];
    let d = startOfDay(anchorDate);

    while (d <= windowEnd) {
      const iso = jsToIso(d.getDay());
      const dateISO = toISODate(d);
      const isHoliday = holidayMap.has(dateISO);
      const isClosure = closureSet.has(dateISO);

      if (branch.isoDays.includes(iso)) {
        if (isHoliday || isClosure) {
          const reason = [
            isHoliday ? `Feiertag: ${holidayMap.get(dateISO)}` : "",
            isClosure ? "Urlaub / Ausfall" : ""
          ].filter(Boolean).join(" + ");
          if (!notes.has(dateISO)) notes.set(dateISO, []);
          notes.get(dateISO).push({kind:"OFF", text: reason || "Kein Unterricht"});
        } else {
          if (branch.type === "HAFEN") {
            if (d >= windowStart) events.push({dateISO, kind:"HAFEN", title:"LKW/BUS-Theorie", timeText: branch.timeText});
          } else {
            if (d >= windowStart) {
              const lessonNo = (topicIndex % TOPICS.length) + 1;
              events.push({dateISO, kind:"PKW", lessonNo, topicText: TOPICS[topicIndex % TOPICS.length], timeText: branch.timeText});
            }
            topicIndex++;
          }
        }
      }
      d = addDays(d,1);
    }

    const notesObj = {};
    for (const [k,arr] of notes.entries()){
      const dt = new Date(k+"T00:00:00");
      if (dt >= windowStart && dt <= windowEnd) notesObj[k] = arr;
    }
    return {events, notesObj};
  }

  // UI state
  let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let currentView = "both"; // both | cal | list

  function setView(mode){
    currentView = mode;
    $("viewBoth").classList.toggle("active", mode==="both");
    $("viewCal").classList.toggle("active", mode==="cal");
    $("viewList").classList.toggle("active", mode==="list");

    $("calendarWrap").style.display = (mode==="list") ? "none" : "block";
    $("listWrap").style.display = (mode==="cal") ? "none" : "block";
  }

  function buildBranchButtons(){
    elBranchBar.innerHTML = "";
    for (const b of BRANCHES){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "bbtn";
      btn.dataset.id = b.id;
      btn.innerHTML = `<span class="dot" style="background:${b.accent}"></span><span class="label">${escapeHtml(b.name)}</span>`;
      btn.addEventListener("click", () => {
        elBranch.value = b.id;
        applyBranchAccent();
        highlightBranchButtons();
        renderAll();
      });
      elBranchBar.appendChild(btn);
    }
  }
  function highlightBranchButtons(){
    const current = elBranch.value;
    [...elBranchBar.querySelectorAll(".bbtn")].forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.id === current);
    });
  }

  function openModal({title, meta, badge, body}){
    mTitle.textContent = title || "";
    mMeta.textContent = meta || "";
    mBadge.textContent = badge || "";
    mBody.textContent = body || "";
    modalOverlay.style.display = "flex";
  }
  function closeModal(){ modalOverlay.style.display = "none"; }

  function computeNextLesson(events){
    const now = startOfDay(new Date());
    const sorted = [...events].sort((a,b)=>a.dateISO.localeCompare(b.dateISO));
    return sorted.find(e => new Date(e.dateISO+"T00:00:00") >= now) || null;
  }

  function renderNext(branch, events){
    const next = computeNextLesson(events);
    if (!next){
      elNextLine.textContent = "‚Äî";
      elNextSub.textContent = "Keine Termine im Zeitraum.";
      return;
    }
    const d = new Date(next.dateISO+"T00:00:00");
    const wk = fmtWk(d).replace(".", "");
    const dm = fmtDayMonth(d);

    if (next.kind === "HAFEN"){
      elNextLine.textContent = `${wk}, ${dm} ‚Ä¢ üöõ LKW/BUS`;
      elNextSub.textContent = `${branch.name} ‚Ä¢ ${branch.timeText}`;
    } else {
      const emoji = TOPIC_EMOJIS[next.lessonNo-1] || "üöó";
      elNextLine.textContent = `${wk}, ${dm} ‚Ä¢ THEMA ${next.lessonNo} ${emoji}`;
      elNextSub.textContent = `${next.topicText} ‚Ä¢ ${branch.timeText}`;
    }
  }

  function renderAll(){
    applyBranchAccent();

    const b = getBranch();
    const yearNow = new Date().getFullYear();
    const closureSet = parseClosureSet((CONFIG.closures[b.id] || []));
    const {events, notesObj} = buildScheduleForward(b, yearNow, closureSet);

    const todayISO = toISODate(new Date());
    const eventsUpcoming = events.filter(e => e.dateISO >= todayISO);

    renderNext(b, eventsUpcoming.length ? eventsUpcoming : events);
    renderCalendar(b, events, notesObj);
    renderList(b, eventsUpcoming, notesObj);

    highlightBranchButtons();
  }

  function renderCalendar(branch, events, notesObj){
    const eventMap = new Map();
    for (const e of events){
      if (!eventMap.has(e.dateISO)) eventMap.set(e.dateISO, []);
      eventMap.get(e.dateISO).push(e);
    }

    const y=currentMonth.getFullYear();
    const m=currentMonth.getMonth();
    const firstOfMonth = new Date(y,m,1);
    const firstIso = jsToIso(firstOfMonth.getDay());
    const gridStart = addDays(firstOfMonth, -(firstIso - 1));

    elMonthTitle.textContent = new Intl.DateTimeFormat("de-DE",{month:"long",year:"numeric"}).format(firstOfMonth);

    elCalBody.innerHTML="";
    let d=startOfDay(gridStart);
    const now = new Date();
    const todayISO = toISODate(now);

    for (let week=0;week<6;week++){
      const tr=document.createElement("tr");
      for (let i=0;i<7;i++){
        const td=document.createElement("td");
        td.className="day";
        if (d.getMonth()!==m) td.classList.add("muted");

        const dayISO = toISODate(d);
        if (dayISO < todayISO) td.classList.add("past");
        if (d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate()) td.classList.add("today");

        const wk = fmtWk(d).replace(".", "");
        td.innerHTML = `
          <div class="dateLine">
            <span class="wk">${wk}</span>
            <strong>${pad2(d.getDate())}.${pad2(d.getMonth()+1)}</strong>
          </div>`;

        const wrap=document.createElement("div");
        wrap.className="badges";

        const ns = notesObj[dayISO] || [];
        for (const n of ns){
          const div=document.createElement("div");
          div.className = (n.kind==="OFF") ? "badge off" : "badge holiday";
          div.innerHTML = `
            <div class="top">
              <strong>${n.kind==="OFF" ? "Kein Unterricht" : "Feiertag"}</strong>
              <span class="tag">${n.kind==="OFF" ? "OFF" : "Hinweis"}</span>
            </div>
            <div>${escapeHtml(n.text)}</div>`;
          div.addEventListener("click", () => {
            openModal({
              title: n.kind==="OFF" ? "Kein Unterricht" : "Feiertag",
              meta: `${branch.name} ‚Ä¢ ${fmtDE(new Date(dayISO+"T00:00:00"))}`,
              badge: n.kind==="OFF" ? "OFF" : "Feiertag",
              body: n.text
            });
          });
          wrap.appendChild(div);
        }

        const evs = eventMap.get(dayISO) || [];
        for (const e of evs){
          const div=document.createElement("div");

          if (e.kind === "HAFEN") {
            div.className = "badge hafen";
            div.innerHTML = `
              <div class="top">
                <strong style="font-size:15px;font-weight:950">üöõ LKW / BUS</strong>
                <span class="tag">Hafen</span>
              </div>
              <div style="font-size:12px;color:#334155">${escapeHtml(e.timeText)}</div>`;
            div.addEventListener("click", () => {
              openModal({
                title: "üöõ LKW / BUS ‚Äì Theorie",
                meta: `${branch.name} ‚Ä¢ ${fmtDE(new Date(e.dateISO+"T00:00:00"))}`,
                badge: `Hafen ‚Ä¢ ${e.timeText}`,
                body: "Spezialunterricht im Hafen (LKW/BUS)."
              });
            });
          } else {
            div.className = "badge";
            const s = topicStyle(e.lessonNo);
            div.style.background = s.bg;
            div.style.borderColor = s.border;
            div.style.boxShadow = "inset 6px 0 0 0 " + s.border;

            const emoji = TOPIC_EMOJIS[e.lessonNo-1] || "üöó";
            div.innerHTML = `
              <div class="top">
                <strong style="font-size:14px;font-weight:950">THEMA ${e.lessonNo} ${emoji}</strong>
                <span class="tag">PKW</span>
              </div>
              <div style="font-weight:650">${escapeHtml(e.topicText)}</div>
              <div style="margin-top:4px;font-size:11px;color:#334155">${escapeHtml(e.timeText)}</div>`;
            div.addEventListener("click", () => {
              openModal({
                title: `THEMA ${e.lessonNo} ${emoji}`,
                meta: `${branch.name} ‚Ä¢ ${fmtDE(new Date(e.dateISO+"T00:00:00"))} ‚Ä¢ ${e.timeText}`,
                badge: "üöó PKW Theorie",
                body: e.topicText
              });
            });
          }

          wrap.appendChild(div);
        }

        if (wrap.childNodes.length) td.appendChild(wrap);
        tr.appendChild(td);
        d=addDays(d,1);
      }
      elCalBody.appendChild(tr);
    }
  }

  function renderList(branch, eventsUpcoming, notesObj){
    const y=currentMonth.getFullYear();
    const m=currentMonth.getMonth();
    const monthISO = `${y}-${pad2(m+1)}-`;

    const monthEvents = eventsUpcoming
      .filter(e=>e.dateISO.startsWith(monthISO))
      .sort((a,b)=>a.dateISO.localeCompare(b.dateISO));

    const todayISO = toISODate(new Date());
    const monthNotes = Object.entries(notesObj)
      .filter(([dateISO]) => dateISO.startsWith(monthISO) && dateISO >= todayISO)
      .sort(([a],[b]) => a.localeCompare(b));

    elListWrap.innerHTML = `
      <div class="listHead">
        <h3>N√§chste Termine im Monat</h3>
        <div class="hint">${escapeHtml(branch.name)}</div>
      </div>
    `;

    if (!monthEvents.length && !monthNotes.length){
      elListWrap.innerHTML += `<div class="small">Keine kommenden Eintr√§ge in diesem Monat.</div>`;
      return;
    }

    for (const [dateISO, arr] of monthNotes){
      for (const n of arr){
        const item=document.createElement("div");
        item.className="item";
        const d=new Date(dateISO+"T00:00:00");
        const tag = (n.kind==="OFF") ? "OFF" : "Feiertag";
        item.innerHTML = `
          <div class="when">${fmtDE(d)} <span class="tag">${escapeHtml(tag)}</span></div>
          <div class="small">${escapeHtml(n.text)}</div>`;
        item.addEventListener("click", () => {
          openModal({
            title: n.kind==="OFF" ? "Kein Unterricht" : "Feiertag",
            meta: `${branch.name} ‚Ä¢ ${fmtDE(d)}`,
            badge: tag,
            body: n.text
          });
        });
        elListWrap.appendChild(item);
      }
    }

    for (const e of monthEvents){
      const item=document.createElement("div");
      item.className="item";
      const d=new Date(e.dateISO+"T00:00:00");

      if (e.kind==="HAFEN"){
        item.innerHTML = `
          <div class="when">${fmtDE(d)} ‚Ä¢ ${escapeHtml(e.timeText)} <span class="tag">üöõ Hafen</span></div>
          <div class="small">LKW/BUS-Theorie</div>`;
        item.addEventListener("click", () => {
          openModal({
            title: "üöõ LKW / BUS ‚Äì Theorie",
            meta: `${branch.name} ‚Ä¢ ${fmtDE(d)} ‚Ä¢ ${e.timeText}`,
            badge: "Hafen",
            body: "Spezialunterricht im Hafen (LKW/BUS)."
          });
        });
      } else {
        const emoji = TOPIC_EMOJIS[e.lessonNo-1] || "üöó";
        item.innerHTML = `
          <div class="when">${fmtDE(d)} ‚Ä¢ ${escapeHtml(e.timeText)} <span class="tag">üöó PKW</span></div>
          <div class="small" style="font-weight:950;color:#111827">THEMA ${e.lessonNo} ${emoji}</div>
          <div class="small">${escapeHtml(e.topicText)}</div>`;
        item.addEventListener("click", () => {
          openModal({
            title: `THEMA ${e.lessonNo} ${emoji}`,
            meta: `${branch.name} ‚Ä¢ ${fmtDE(d)} ‚Ä¢ ${e.timeText}`,
            badge: "üöó PKW Theorie",
            body: e.topicText
          });
        });
      }
      elListWrap.appendChild(item);
    }
  }

  function init(){
    elBranch.innerHTML="";
    for (const b of BRANCHES){
      const opt=document.createElement("option");
      opt.value=b.id;
      opt.textContent=`${b.name} ‚Ä¢ ${b.dayLabel} ‚Ä¢ ${b.timeText}`;
      elBranch.appendChild(opt);
    }
    elBranch.value = "innenstadt";

    buildBranchButtons();
    applyBranchAccent();
    highlightBranchButtons();

    elBranch.addEventListener("change", ()=>{ applyBranchAccent(); highlightBranchButtons(); renderAll(); });

    $("prevMonth").addEventListener("click", ()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
      renderAll();
    });
    $("nextMonth").addEventListener("click", ()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
      renderAll();
    });
    $("goToday").addEventListener("click", ()=>{
      const n = new Date();
      currentMonth = new Date(n.getFullYear(), n.getMonth(), 1);
      renderAll();
      $("mainCard").scrollIntoView({behavior:"smooth", block:"start"});
    });

    $("viewBoth").addEventListener("click", ()=>setView("both"));
    $("viewCal").addEventListener("click", ()=>setView("cal"));
    $("viewList").addEventListener("click", ()=>setView("list"));

    $("mClose").addEventListener("click", ()=>{ modalOverlay.style.display="none"; });
    modalOverlay.addEventListener("click", (e)=>{ if (e.target === modalOverlay) modalOverlay.style.display="none"; });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") modalOverlay.style.display="none"; });

    if (window.matchMedia && window.matchMedia("(max-width: 820px)").matches) setView("list");
    else setView("both");

    renderAll();
  }

  init();
})();
</script>
</body>
</html>
